#!/usr/bin/env perl
use v5.14;
use lib './lib';
use Catmandu qw(importer exporter);
use JSON;

my $verbose;

foreach my $isil (@ARGV) {
    if ($isil eq '-v') {
        $verbose = JSON->new->utf8->canonical->pretty;
        next;
    }
    $isil =~ s|(\./)?isil/([^/]+)(/sites\.txt)?$|$2|;

    my $infile  = "isil/$isil/sites.txt";
    my $outfile = "isil/$isil/sites.yaml";

    if ($isil !~ /^[A-Z]{1,3}-[A-Za-z0-9\/:-]{1,10}$/) {
        warn "invalid ISIL $isil\n";
        next;  
    } elsif ( ! -f $infile ) {
        warn "missing $infile\n";
        next;
    }

    my $exporter = exporter('YAML', file => $outfile);
    importer('Libsites', file => $infile, isil => $isil)->each(sub{
        print $verbose->encode($_[0]) if $verbose;
        $exporter->add($_[0]);
    });

    say "$outfile - ".$exporter->count." departments";
}
